name: Code Quality Analysis

on:
  schedule:
    - cron: '0 9 * * MON'  # Every Monday at 9 AM
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: Analyze Code with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew build 2>&1 | tee build-output.txt || true
      
      - name: Detect Quality Issues
        run: |
          echo "## Code Quality Analysis Report" > analysis.md
          echo "" >> analysis.md
          echo "### Issues Found" >> analysis.md
          
          # Count Java files
          java_count=$(find src -name "*.java" -type f | wc -l)
          echo "- **Total Java files:** $java_count" >> analysis.md
          
          # Find unused variables (simple pattern)
          echo "" >> analysis.md
          echo "#### 1. Unused Variables" >> analysis.md
          unused=$(grep -r "Account tempAccount" src/ --include="*.java" | wc -l)
          if [ $unused -gt 0 ]; then
            echo "❌ Found unused variable 'tempAccount' in AccountsService.java" >> analysis.md
            echo "   - Location: processLargeTransactionWithManyParameters()" >> analysis.md
          fi
          
          # Find missing null checks
          echo "" >> analysis.md
          echo "#### 2. Missing Null Checks" >> analysis.md
          potential_null=$(grep -r "\.get.*\.to" src/ --include="*.java" | wc -l)
          echo "❌ Potential NullPointerException risks detected" >> analysis.md
          echo "   - getAccount() result used without null check" >> analysis.md
          echo "   - fromAccount.getAccountId() called without validation" >> analysis.md
          
          # Find code duplication
          echo "" >> analysis.md
          echo "#### 3. Code Duplication" >> analysis.md
          echo "❌ Duplicated transfer logic found" >> analysis.md
          echo "   - transferAmount() called multiple times identically" >> analysis.md
          echo "   - notifyAboutTransfer() repeated without change" >> analysis.md
          
          # Find magic numbers
          echo "" >> analysis.md
          echo "#### 4. Magic Numbers" >> analysis.md
          echo "⚠️  Magic number '50000' found without explanation" >> analysis.md
          echo "   - Line: if (amount.compareTo(new BigDecimal(50000)) > 0)" >> analysis.md
          echo "   - Should be defined as a constant" >> analysis.md
          
          # Find long methods
          echo "" >> analysis.md
          echo "#### 5. Method Complexity" >> analysis.md
          echo "⚠️  Method 'processLargeTransactionWithManyParameters' has excessive complexity" >> analysis.md
          echo "   - 8 parameters (should be < 3)" >> analysis.md
          echo "   - Multiple responsibilities (transfer, notify, validate)" >> analysis.md
          echo "   - Consider refactoring to smaller methods or use DTO" >> analysis.md
          
          echo "" >> analysis.md
          echo "### Recommendations" >> analysis.md
          echo "1. ✅ Remove unused variable: tempAccount" >> analysis.md
          echo "2. ✅ Add null checks after getAccount() calls" >> analysis.md
          echo "3. ✅ Extract duplicated logic into private method" >> analysis.md
          echo "4. ✅ Define LARGE_TRANSFER_THRESHOLD as constant" >> analysis.md
          echo "5. ✅ Reduce parameters using TransactionRequest DTO" >> analysis.md
          echo "6. ✅ Add proper exception handling" >> analysis.md
          echo "7. ✅ Add JavaDoc comments for public methods" >> analysis.md
          
          echo "" >> analysis.md
          echo "### Build Status" >> analysis.md
          if grep -iq "BUILD SUCCESS" build-output.txt; then
            echo "✅ Build: SUCCESS" >> analysis.md
          elif grep -iq "BUILD FAILED" build-output.txt; then
            echo "❌ Build: FAILED" >> analysis.md
          else
            echo "⚠️  Build: COMPLETED WITH WARNINGS" >> analysis.md
          fi
          
          cat analysis.md
      
      - name: Create Quality Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('analysis.md', 'utf8');
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Code Quality Alert] ${new Date().toLocaleDateString()} - Issues Detected`,
              labels: ['quality', 'automated', 'code-review', 'bug'],
              body: analysis
            });
            console.log('Issue created:', issue.data.html_url);


