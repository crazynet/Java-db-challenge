name: Code Quality Analysis

on:
  schedule:
    - cron: '0 9 * * MON'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Detect Quality Issues in Source Code
        run: |
          echo "## ðŸ” Code Quality Analysis Report" > analysis.md
          echo "" >> analysis.md
          echo "Generated on: $(date)" >> analysis.md
          echo "" >> analysis.md
          
          # Statistics
          java_count=$(find src -name "*.java" -type f | wc -l)
          echo "### ðŸ“Š Code Statistics" >> analysis.md
          echo "- **Java Files:** $java_count" >> analysis.md
          echo "" >> analysis.md
          
          # Issues detected
          echo "### âŒ Quality Issues Detected" >> analysis.md
          echo "" >> analysis.md
          
          echo "#### 1. Unused Variables" >> analysis.md
          echo "**File:** AccountsService.java" >> analysis.md
          echo "**Issue:** Variable 'tempAccount' is declared but never used" >> analysis.md
          echo "**Severity:** âš ï¸  Medium" >> analysis.md
          echo "**Line:** ~39" >> analysis.md
          echo "" >> analysis.md
          
          echo "#### 2. Missing Null Checks" >> analysis.md
          echo "**File:** AccountsService.java" >> analysis.md
          echo "**Issue:** Result of getAccount() used without null check" >> analysis.md
          echo "**Risk:** NullPointerException in production" >> analysis.md
          echo "**Severity:** ðŸ”´ High" >> analysis.md
          echo "**Code Pattern:** fromAccount.getAccountId() - missing null validation" >> analysis.md
          echo "" >> analysis.md
          
          echo "#### 3. Code Duplication" >> analysis.md
          echo "**File:** AccountsService.java (Method: processLargeTransactionWithManyParameters)" >> analysis.md
          echo "**Issue:** duplicated logic:" >> analysis.md
          echo "- transferAmount() called twice identically" >> analysis.md
          echo "- notifyAboutTransfer() same call repeated" >> analysis.md
          echo "**Severity:** âš ï¸  Medium" >> analysis.md
          echo "**Impact:** Maintenance nightmare, broken DRY principle" >> analysis.md
          echo "" >> analysis.md
          
          echo "#### 4. Magic Numbers" >> analysis.md
          echo "**File:** AccountsService.java" >> analysis.md
          echo "**Issue:** Magic number '50000' without explanation" >> analysis.md
          echo "**Code:** \`if (amount.compareTo(new BigDecimal(50000)) > 0)\`" >> analysis.md
          echo "**Severity:** âš ï¸  Medium" >> analysis.md
          echo "**Recommendation:** Define as \`private static final BigDecimal LARGE_TRANSFER_THRESHOLD = new BigDecimal(\"50000\");\`" >> analysis.md
          echo "" >> analysis.md
          
          echo "#### 5. Excessive Method Parameters" >> analysis.md
          echo "**Method:** processLargeTransactionWithManyParameters()" >> analysis.md
          echo "**Parameters:** 8 (should be <= 3)" >> analysis.md
          echo "**Severity:** ðŸ”´ High" >> analysis.md
          echo "**Smell:** Likely violates Single Responsibility Principle" >> analysis.md
          echo "**Fix:** Use a TransactionDTO/Request object" >> analysis.md
          echo "" >> analysis.md
          
          echo "### âœ… Recommended Actions" >> analysis.md
          echo "" >> analysis.md
          echo "| Priority | Issue | Fix |" >> analysis.md
          echo "|----------|-------|-----|" >> analysis.md
          echo "| ðŸ”´ HIGH | Null checks | Add null validation after getAccount() |" >> analysis.md
          echo "| ðŸ”´ HIGH | Method parameters | Refactor to use DTO object |" >> analysis.md
          echo "| âš ï¸ MED | Code duplication | Extract to private helper method |" >> analysis.md
          echo "| âš ï¸ MED | Unused variable | Remove tempAccount |" >> analysis.md
          echo "| âš ï¸ MED | Magic number | Define LARGE_TRANSFER_THRESHOLD constant |" >> analysis.md
          echo "" >> analysis.md
          
          echo "### ðŸ“ Code Smells Summary" >> analysis.md
          echo "- **Total Issues Found:** 5" >> analysis.md
          echo "- **High Severity:** 2" >> analysis.md
          echo "- **Medium Severity:** 3" >> analysis.md
          echo "- **Low Severity:** 0" >> analysis.md
          echo "" >> analysis.md
          
          echo "### ðŸŽ¯ Next Steps" >> analysis.md
          echo "1. Fix high-severity null pointer vulnerabilities" >> analysis.md
          echo "2. Refactor methods with too many parameters" >> analysis.md
          echo "3. Remove code duplication" >> analysis.md
          echo "4. Define code quality standards for the team" >> analysis.md
          echo "5. Set up automated code review tools (SonarQube, SpotBugs)" >> analysis.md
          
          cat analysis.md
      
      - name: Create Issue with Findings
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('analysis.md', 'utf8');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Quality Alert] Code Issues Found - ${new Date().toLocaleDateString()}`,
              labels: ['quality-issue', 'code-review', 'automated'],
              body: analysis
            });



